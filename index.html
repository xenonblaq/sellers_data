<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Dropdowns</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        @font-face {
            font-family: 'DIN Pro';
            src: url('https://example.com/fonts/DINPro-Regular.woff2') format('woff2');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'DIN Pro', sans-serif;
            color: #2b2765;
            display: flex;
            justify-content: flex-start; /* Указано flex-start для корректного позиционирования */
            align-items: center;
            height: 100vh;
            flex-direction: column;
            margin: 0;
            padding-top: 50px; /* Добавлен отступ сверху, чтобы элементы располагались ниже */
        }

        #header {
            width: 100%;
            height: 60px;
            background-color: #5C4B9A; /* Цвет прямоугольника */
            position: fixed;
            top: 0;
            left: 0;
        }

        #logo {
            margin-bottom: 5px; /* Уменьшенное расстояние между логотипом и текстом */
            margin-top: 20px; /* Уменьшенный отступ сверху после прямоугольника */
        }

        #logo img {
            width: 300px; /* Логотип увеличен в два раза */
            height: auto;
        }

        #namePage, #dropdownPage {
            display: none;
            text-align: center;
        }

        .dropdown-container {
            display: flex;
            gap: 40px;
            margin-bottom: 20px;
        }

        select {
            width: 200px;
            border: 1px solid #ccc;
            padding: 5px;
        }

        /* Цвет для активных и неактивных выпадающих окон */
        .select2-container--default .select2-selection--single {
            background-color: #e6e6fa; /* Лавандовый цвет */
            border-color: #ccc;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: #5C4B9A;
            font-family: 'DIN Pro', sans-serif;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            border-left: 1px solid #ccc;
        }

        /* Цвет для отключенного выпадающего списка */
        .select2-container--default.select2-container--disabled .select2-selection--single {
            background-color: #e6e6fa !important; /* Лавандовый цвет даже когда отключено */
            color: #5C4B9A;
        }

        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            width: 300px;
            margin-bottom: 20px;
            background-color: #e6e6fa; /* Лавандовый цвет для поля ввода имени */
        }

        button {
            padding: 10px 20px;
            font-family: 'DIN Pro', sans-serif;
            color: white;
            background-color: #5C4B9A;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #5C4B9A;
        }

        .instruction {
            font-family: 'DIN Pro', sans-serif;
            color: #2b2765;
            max-width: 880px;
            font-size: 24px; /* Увеличенный размер текста */
            font-weight: 300;
            margin-bottom: 20px;
        }

        #namePage .instruction {
            font-size: 28px; /* Увеличенный размер текста для первой страницы */
            margin-bottom: 20px;
            font-weight: 300;
        }

        .dropdown-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .button-group button {
            margin-bottom: 10px;
        }

    </style>
</head>
<body>

<!-- Прямоугольник наверху страниц -->
<div id="header"></div>

<!-- Логотип на обеих страницах -->
<div id="logo">
    <img src="logo.png" alt="Логотип">
</div>

<!-- Страница ввода имени -->
<div id="namePage">
    <p class="instruction">
        Для доступа к персональной таблице продавца введите первое слово в официальном названии.
        Для ИП - фамилия, иначе - символы до первого пробела.<br>
        <br>
    </p>
    <input type="text" id="userName" placeholder="Введите ваше имя" />
    <button id="startBtn">Старт</button>
    <p class="instruction">
        Это нужно для выгрузки данных о контрагентах конкретного продавца.
    </p>
</div>

<!-- Страница с выпадающими списками -->
<div id="dropdownPage">
    <p class="instruction">
        Добавьте данные о продажах. Для этого в выпадающих списках найдите нужного контрагента, конечного получателя, 
        номенклатурную группу<br> и номенклатуру. Далее нажмите кнопку «Добавить».
        Обратите внимание: выбрать номенклатуру можно лишь после выбора группы.
        Если же вам нужно внести данные о нескольких продажах, повторите предыдущий алгоритм.
        Когда все данные будут добавлены, нажмите кнопку «Скачать Excel» для финального результата.<br>
        <br>
    </p>

    <div class="dropdown-wrapper">
        <div class="dropdown-container" id="dropdownGroup">
            <!-- Первый выпадающий список -->
            <select class="select2" id="dropdown1">
                <option value="">Выберите контрагента</option>
            </select>

            <!-- Второй выпадающий список -->
            <select class="select2" id="dropdown3">
                <option value="">Выберите конечного получателя</option>
            </select>

            <!-- Третий выпадающий список (категории) -->
            <select class="select2" id="dropdownCategory">
                <option value="">Выберите продуктовое направление</option>
            </select>

            <!-- Четвертый выпадающий список (товары по выбранной категории) -->
            <select class="select2" id="dropdownGood" disabled multiple>
                <option value="all">Выбрать все</option>
                <option value="">Номенклатура</option>
            </select>
        </div>

        <div class="button-group">
            <button id="addBtn">Добавить</button>
            <button id="downloadBtn">Скачать Excel</button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="agents.js"></script> <!-- Подключаем файл со словарем agents -->
<script src="goods.js"></script> <!-- Подключаем файл со словарем agents -->

<script>
    $(document).ready(function() {
        let excelData = [];  // Массив для хранения строк данных

        const headers = ["УИД Контрагент", "Контрагент.Код", "Контрагент", "УИД Конечный получатель", "Конечный получатель код",
         "Конечный получатель", "УИД Продуктовое направление", "Продуктовое направление", "УИД Номенклатурная группа", "Номенклатурная группа",
          "УИД Номенклатура", "Номенклатура", "УИД Единица измерения", "Единица измерения", "Цена с НДС за единицу измерения в валюте", "Валюта"]
          excelData.push(headers);

        $('.select2').select2();

        // Показать начальную страницу
        $('#namePage').show();

        let userNameGlobal = ''; // Глобальная переменная для хранения имени пользователя

  // Обработчик нажатия кнопки "Старт"
  $('#startBtn').on('click', startProcess);

// Обработчик нажатия Enter в поле ввода имени
$('#userName').on('keydown', function(e) {
    if (e.keyCode === 13) {  // Проверяем, нажата ли клавиша Enter
        startProcess();
    }
});

// Функция для запуска процесса при нажатии кнопки "Старт" или "Enter"
function startProcess() {
    let userName = $('#userName').val().charAt(0).toUpperCase() + $('#userName').val().slice(1).toLowerCase();
    if (!userName) {
        alert("Введите ваше имя");
        return;
    }

    // Сохранение значения userName в глобальной переменной
    userNameGlobal = userName;
    console.log(agents)
    // Проверяем, есть ли имя в словаре agents
    if (agents[userName]) {
        let products = agents[userName];

        // Обновляем списки продуктов (первый и второй)
        updateDropdown1Options(products);
        updateDropdown3Options(products);

        // Обновляем список категорий в третьем выпадающем списке
        updateDropdownCategoryOptions();

        // Скрыть страницу с вводом имени и показать страницу с выпадающими списками
        $('#namePage').hide();
        $('#dropdownPage').show();
    } else {
        alert("Имя не найдено в базе");
    }
}


        // Функция для обновления первого и второго выпадающего списка с продуктами
        function updateDropdown1Options(products) {
    $('#dropdown1').empty().append('<option value="">Контрагент</option>');
    
    // Для каждого элемента внутреннего массива отображаем только первый элемент
    products.forEach(function(product) {
        $('#dropdown1').append('<option value="' + product[0] + '">' + product[0] + '</option>');
    });
    
    $('#dropdown1').select2(); // Перезапуск select2 для обновленного списка
}

function updateDropdown3Options(products) {
    $('#dropdown3').empty().append('<option value="">Конечник</option>');
    
    // Для каждого элемента внутреннего массива отображаем только первый элемент
    products.forEach(function(product) {
        $('#dropdown3').append('<option value="' + product[0] + '">' + product[0] + '</option>');
    });
    
    $('#dropdown3').select2(); // Перезапуск select2 для обновленного списка
}

        // Функция для обновления третьего выпадающего списка (категории)
        function updateDropdownCategoryOptions() {
            $('#dropdownCategory').empty().append('<option value="">Группа</option>');
            Object.keys(goods).forEach(function(category) {
                $('#dropdownCategory').append('<option value="' + category + '">' + category + '</option>');
            });
            $('#dropdownCategory').select2(); // Перезапуск select2 для категорий
        }

        // Обработчик изменения в третьем выпадающем списке (категории)
        $('#dropdownCategory').on('change', function() {
            let selectedCategory = $(this).val();

            // Если категория выбрана, заполняем товары для этой категории
            if (selectedCategory) {
                $('#dropdownGood').prop('disabled', false);
                updateDropdownGoodOptions(selectedCategory);
            } else {
                $('#dropdownGood').prop('disabled', true).empty().append('<option value="">Номенклатура</option>');
            }
        });

// Функция для обновления четвертого выпадающего списка (товары)
function updateDropdownGoodOptions(category) {
    $('#dropdownGood').empty().append('<option value="all">Выбрать все</option>'); // Добавляем пункт "Выбрать все"
    
    // Для каждого элемента внутреннего массива отображаем только второй элемент
    goods[category].forEach(function(good) {
        // Кодируем значение номенклатуры, чтобы избежать проблем с кавычками
        let encodedGood = encodeURIComponent(good[0]);
        $('#dropdownGood').append('<option value="' + encodedGood + '">' + good[0] + '</option>');
    });
    
    $('#dropdownGood').select2(); // Перезапуск select2 для товаров
}

// Обработчик выбора в выпадающем списке
$('#dropdownGood').on('change', function() {
    let selectedOptions = $(this).val();

    if (selectedOptions.includes('all')) {
        // Если выбран пункт "Выбрать все", выбираем все номенклатуры
        $('#dropdownGood').next('.select2-container').find('.select2-selection__rendered').html('Выбрать все');
        let allOptions = $('#dropdownGood option').map(function() {
            return $(this).val();
        }).get();
        
        $('#dropdownGood').val(allOptions).trigger('change'); // Отмечаем все опции
    }
});

$('#addBtn').on('click', function() {
    let product1Index = $('#dropdown1 option:selected').val();
    let product2Index = $('#dropdown3 option:selected').val();
    let category = $('#dropdownCategory option:selected').text();
    let selectedGoods = $('#dropdownGood').val();  // Получаем массив выбранных номенклатур

    // Используем глобальную переменную userNameGlobal
    let userName = userNameGlobal;

    // Проверяем, существуют ли данные для текущего пользователя в agents
    if (!agents[userName] || !Array.isArray(agents[userName])) {
        alert("Ошибка: данные для этого пользователя отсутствуют или они в неверном формате.");
        return;
    }

    // Поиск выбранных элементов по индексу для первого и второго списков
    let product1 = agents[userName].find(arr => arr[0] === product1Index);
    let product2 = agents[userName].find(arr => arr[0] === product2Index);

    if (!product1 || !product2) {
        alert("Ошибка: не удалось найти данные для контрагента или конечного получателя.");
        return;
    }

    // Проверяем, что категория выбрана корректно
    if (!category || !goods[category]) {
        alert("Ошибка: категория не выбрана или не найдена.");
        return;
    }

    // Проверяем, что есть выбранные номенклатуры
    if (!selectedGoods || selectedGoods.length === 0) {
        alert("Пожалуйста, выберите хотя бы одну номенклатуру.");
        return;
    }

    if (selectedGoods[0] == "all") {
        selectedGoods = selectedGoods.slice(1);
    }

    // Теперь проходим по каждой выбранной номенклатуре и добавляем строку данных
    selectedGoods.forEach(function(encodedGoodIndex) {
        // Декодируем значение номенклатуры
        let goodIndex = decodeURIComponent(encodedGoodIndex);
        
        // Находим соответствующий товар
        let good = goods[category].find(arr => arr[0] === goodIndex);

        if (!good) {
            console.log(goodIndex)
            alert("Ошибка: товар не найден.");
            return;
        }

        // Создаем строку данных для экспорта в Excel (по столбцам)
        let rowData = [
            product1[2], product1[1], product1[0], 
            product2[2], product2[1], product2[0], 
            good[1], good[1], good[2], good[3], good[4], good[0], good[5], good[6], good[7], good[8]
        ];

        // Добавляем строку данных в Excel
        excelData.push(rowData);
    });

    // Очистка полей для следующего ввода
    $('#dropdown1').val('').trigger('change');
    $('#dropdown3').val('').trigger('change');
    $('#dropdownCategory').val('').trigger('change');
    $('#dropdownGood').prop('disabled', true).empty().append('<option value="">Номенклатура</option>');
});

        // Обработчик кнопки "Скачать Excel"
        $('#downloadBtn').on('click', function() {
            if (excelData.length === 0) {
                alert("Нет данных для скачивания");
                return;
            }

            // Создание и скачивание Excel файла
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");

            // Скачивание файла
            XLSX.writeFile(wb, "selection.xlsx");
        });
    });
</script>

</body>
</html>